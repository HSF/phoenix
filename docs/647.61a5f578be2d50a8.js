"use strict";(self.webpackChunkphoenix_app=self.webpackChunkphoenix_app||[]).push([[647],{5647:(A,D,f)=>{f.r(D),f.d(D,{TASImagePainter:()=>B});var d=f(5835),g=f(9542),P=f(3038),M=f(6458),w=f(4585),x=f(49);class B extends M.tK{decodeOptions(e){this.options={Zscale:!1},e&&e.indexOf("z")>=0&&(this.options.Zscale=!0)}createRGBA(e){let t=this.getObject();if(!t?.fPalette)return null;let r=new Array(4*(e+1)),a=1,l=t.fPalette;for(let n=0;n<=e;++n){let o=1*n/e;for(;l.fPoints[a]<o&&a<l.fPoints.length-1;)a++;let h=(l.fPoints[a]-o)/(l.fPoints[a]-l.fPoints[a-1]),u=(o-l.fPoints[a-1])/(l.fPoints[a]-l.fPoints[a-1]);r[4*n]=Math.min(255,Math.round((l.fColorRed[a-1]*h+l.fColorRed[a]*u)/256)),r[4*n+1]=Math.min(255,Math.round((l.fColorGreen[a-1]*h+l.fColorGreen[a]*u)/256)),r[4*n+2]=Math.min(255,Math.round((l.fColorBlue[a-1]*h+l.fColorBlue[a]*u)/256)),r[4*n+3]=Math.min(255,Math.round((l.fColorAlpha[a-1]*h+l.fColorAlpha[a]*u)/256))}return r}makeUrlFromImageBuf(e,t){var r=this;return(0,d.Z)(function*(){r.rgba=r.createRGBA(1e3);let l=e.fImgBuf[0],n=e.fImgBuf[0];for(let i=1;i<e.fImgBuf.length;++i){let s=e.fImgBuf[i];l=Math.min(s,l),n=Math.max(s,n)}r.fContour={arr:new Array(200),rgba:r.rgba,getLevels(){return this.arr},getPaletteColor(i,s){if(!this.arr||!this.rgba)return"white";let m=4*Math.round((s-this.arr[0])/(this.arr[this.arr.length-1]-this.arr[0])*(this.rgba.length-4)/4);return"#"+(0,P.NC)(this.rgba[m],1)+(0,P.NC)(this.rgba[m+1],1)+(0,P.NC)(this.rgba[m+2],1)+(0,P.NC)(this.rgba[m+3],1)}};for(let i=0;i<200;i++)r.fContour.arr[i]=l+(n-l)/199*i;l>=n&&(n=l+1);let o=0,h=e.fWidth,u=0,_=e.fHeight;return t&&t.zoom_xmin!=t.zoom_xmax&&(o=Math.round(t.zoom_xmin*e.fWidth),h=Math.round(t.zoom_xmax*e.fWidth)),t&&t.zoom_ymin!=t.zoom_ymax&&(u=Math.round(t.zoom_ymin*e.fHeight),_=Math.round(t.zoom_ymax*e.fHeight)),((0,g.isNodeJs)()?f.e(305).then(f.t.bind(f,8305,19)).then(i=>i.default.createCanvas(h-o,_-u)):new Promise(i=>{let s=document.createElement("canvas");s.width=h-o,s.height=_-u,i(s)})).then(i=>{let s=i.getContext("2d"),m=s.getImageData(0,0,i.width,i.height),b=m.data;for(let c=u;c<_;++c){let C=(_-c-1)*(h-o)*4,T=c*e.fWidth;for(let I=o;I<h;++I){let p=4*Math.round((e.fImgBuf[T+I]-l)/(n-l)*1e3);b[C++]=r.rgba[p++],b[C++]=r.rgba[p++],b[C++]=r.rgba[p++],b[C++]=r.rgba[p++]}}return s.putImageData(m,0,0),{url:i.toDataURL(),constRatio:e.fConstRatio,is_buf:!0}})})()}makeUrlFromPngBuf(e){return(0,d.Z)(function*(){let t=e.fPngBuf,r="";if((0,g.isStr)(t))r=t;else for(let a=0;a<t.length;++a)r+=String.fromCharCode(t[a]<0?256+t[a]:t[a]);return{url:"data:image/png;base64,"+(0,g.btoa_func)(r),constRatio:!0}})()}drawImage(){var e=this;return(0,d.Z)(function*(){let l,t=e.getObject(),r=e.getFramePainter(),a=r?r.getFrameRect():e.getPadPainter().getPadRect();return e.wheel_zoomy=!0,t._blob&&(15!=t._blob.length||t._blob[0]?3==t._blob.length&&t._blob[0]?(t.fPngBuf=t._blob[2],t.fPngBuf?.length!=t._blob[1]&&(console.error(`TASImage with png buffer _blob error ${t._blob[1]} != ${t.fPngBuf?.length}`),delete t.fPngBuf)):console.error(`TASImage _blob len ${t._blob.length} not recognized`):(t.fImageQuality=t._blob[1],t.fImageCompression=t._blob[2],t.fConstRatio=t._blob[3],t.fPalette={_typename:"TImagePalette",fUniqueID:t._blob[4],fBits:t._blob[5],fNumPoints:t._blob[6],fPoints:t._blob[7],fColorRed:t._blob[8],fColorGreen:t._blob[9],fColorBlue:t._blob[10],fColorAlpha:t._blob[11]},t.fWidth=t._blob[12],t.fHeight=t._blob[13],t.fImgBuf=t._blob[14],(t.fWidth*t.fHeight!=t.fImgBuf.length||t.fPalette.fNumPoints!=t.fPalette.fPoints.length)&&(console.error(`TASImage _blob decoding error ${t.fWidth*t.fHeight} != ${t.fImgBuf.length} ${t.fPalette.fNumPoints} != ${t.fPalette.fPoints.length}`),delete t.fImgBuf,delete t.fPalette)),delete t._blob),l=t.fImgBuf&&t.fPalette?e.makeUrlFromImageBuf(t,r):t.fPngBuf?e.makeUrlFromPngBuf(t):Promise.resolve({}),l.then(n=>(n.url&&e.createG(!!r).append("image").attr("href",n.url).attr("width",a.width).attr("height",a.height).attr("preserveAspectRatio",n.constRatio?null:"none"),n.url&&e.isMainPainter()&&n.is_buf&&r?e.drawColorPalette(e.options.Zscale,!0).then(()=>(r.setAxesRanges((0,g.create)(g.clTAxis),0,1,(0,g.create)(g.clTAxis),0,1,null,0,0),r.createXY({ndim:2,check_pad_range:!1}),r.addInteractivity())):e))})()}canZoomInside(e,t,r){let a=this.getObject();return!!a?.fImgBuf&&("x"==e&&(r-t)*a.fWidth>3||"y"==e&&(r-t)*a.fHeight>3)}drawColorPalette(e,t){var r=this;return(0,d.Z)(function*(){if(!r.isMainPainter())return null;if(!r.draw_palette){let o=(0,g.create)(g.clTPaletteAxis);Object.assign(o,{fX1NDC:.91,fX2NDC:.95,fY1NDC:.1,fY2NDC:.9,fInit:1}),o.fAxis.fChopt="+",r.draw_palette=o,r.fPalette=!0}let a=r.getPadPainter().findPainterFor(r.draw_palette);if(!e)return a&&(a.Enabled=!1,a.removeG()),null;let l=r.getFramePainter();if(t&&l){let o=r.draw_palette;o.fX2NDC=l.fX2NDC+.01+(o.fX2NDC-o.fX1NDC),o.fX1NDC=l.fX2NDC+.01,o.fY1NDC=l.fY1NDC,o.fY2NDC=l.fY2NDC}if(a)return a.Enabled=!0,a.drawPave("");let n=r.selectCurrentPad(r.getPadName());return w.TPavePainter.draw(r.getDom(),r.draw_palette).then(o=>{a=o,r.selectCurrentPad(n),a.$secondary=!0,a.redraw=function(){}})})()}toggleColz(){let e=this.getObject();e&&e.fPalette&&(this.options.Zscale=!this.options.Zscale,this.drawColorPalette(this.options.Zscale,!0))}redraw(e){let t=this.draw_g?this.draw_g.select("image"):null,r=this.getFramePainter();if(!t||t.empty()||"zoom"===e||!r)return this.drawImage();t.attr("width",r.getFrameWidth()).attr("height",r.getFrameHeight())}clickButton(e){return!!this.isMainPainter()&&"ToggleColorZ"===e&&(this.toggleColz(),!0)}fillToolbar(){let e=this.getPadPainter(),t=this.getObject();e&&t?.fPalette&&(e.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),e.showPadButtons())}static draw(e,t,r){return(0,d.Z)(function*(){let a=new B(e,t,r);return a.decodeOptions(r),(0,x.ensureTCanvas)(a,!1).then(()=>a.drawImage()).then(()=>(a.fillToolbar(),a))})()}}}}]);
//# sourceMappingURL=647.61a5f578be2d50a8.js.map